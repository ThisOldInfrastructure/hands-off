<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
  <HEAD>

    <TITLE>Hands-Off auto-installer --- building images</TITLE>
    <LINK REL="stylesheet" HREF="/styles/site.css">
    <link rel="shortcut icon" href="favicon.ico" />
    <META NAME="Author" CONTENT="phil@hands.com (Philip Hands)">
      <META NAME="Description" CONTENT="The Hands-Off auto-installer provides a method for installing Debian GNU/Linux without user interaction, with the configuration being obtained from a variety of sources, and supporting all the boot methods that Debian itself supports.">
	<meta name=keywords content="Debian GNU Linux iautomatic installation">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">


  </HEAD>
  <BODY bgcolor="#ffffff">
  <h1>Hands-Off auto-installer --- building images</h1>

  <p><em>This is in a state of flux, so the documentation tends to
  drift out of date quite quickly -- it should settle down and become
  easier as more of the code gets into debian-installer propper</em>

  <p>In order to build the relevant initrd images for your prefered
  boot medium, you need to do the following:

  <p>Check out the main d-i installer area from the Debian subversion repository:
<pre>
$ mkdir -p ~/di-build-area/packages
$ svn co svn://svn.debian.org/svn/d-i/trunk/installer ~/di-build-area/installer
</pre>
as well as any of the following that have not been released yet:
<pre>
# if auto-install_0.05 has not yet been released:
$ svn co svn://svn.debian.org/svn/d-i/trunk/packages/auto-install ~/di-build-area/pakages/
# if base-installer_1.67 has not yet been released:
$ svn co svn://svn.debian.org/svn/d-i/trunk/packages/base-installer ~/di-build-area/pakages/
# if preseed_1.18 has not yet been released:
$ svn co svn://svn.debian.org/svn/d-i/trunk/packages/preseed ~/di-build-area/pakages/
# if kbd-chooser_1.30 has not yet been released:
$ svn co svn://svn.debian.org/svn/d-i/trunk/packages/kbd-chooser ~/di-build-area/pakages/
# if localechooser_1.23 has not yet been released:
$ svn co svn://svn.debian.org/svn/d-i/trunk/packages/localechooser ~/di-build-area/pakages/
</pre>
then change into each directory under the ~/di-build-area/packages
directory, and build the .udebs needed for the images by running
debuild in each.

<p>Don't worry about warnings that "running debsign failed".  You may
need to install devscripts and some build dependencies in order to get
those steps to work.  Then we change to the debian-installer build
directory:

<pre>
$ cd ~/di-build-area/installer/build/
</pre>

and follow the instructions in the README found there, after copying
your locally built udebs into the localudebs directory.

Here are the steps required (for those that are to bust to read docs):

<pre>
$ ( cd .. ; dpkg-checkbuilddeps )
#### and install the packages it asks for

$ make reallyclean
#### do this whenever anything slightly odd seems to be happening
#### because the Makefile is not very bright when it comes to working
#### out when it needs to re-do things, and sometimes it doesn't when it should

$ cp ~/di-build-area/packages/*.udeb localudebs/

$ make
#### to get a list of possible targets

$ fakeroot make build_netboot build_netboot_2.6
#### for example "all_build" is also a useful target

#### You may find that you need to tweak the sources used for getting
#### packages -- if so, copy the auto-generated sources.list.udeb
#### to sources.list.udeb.local and edit that.
#### Note: the sources.list.udeb.local file overrides the autogenerated
#### one, so if it exists sources.list.udeb is totally ignored
</pre>

Once done, the resulting images should turn up in dest, and you should
then be able to drop them into place on the relevant boot medium.

<h2>Creating CD images</h2>

<p>loop mount the image you want to base your custom one on:
<pre>
$ mount -o loop,ro debian-31r1a-i386-netinst.iso /mnt
</pre>
create a working directory, and copy the contents there, and make the
copy writable:
<pre>  
$ mkdir d-i-CD
$ cp -a /mnt d-i-CD/new
$ chmod -R +w d-i-CD/new
</pre>
and unmount the cd image:
<pre>
$ umount /mnt
</pre>
now copy the initrd images you created above into these locations in the unpacked CD directory tree:
<pre>
    d-i-CD/new/install/2.6/initrd.gz
    d-i-CD/new/install/initrd.gz
</pre>
Also edit d-i-CD/new/isolinux/isolinux.txt, adding something above the boot
prompt so it's clear that you've tweaked the image. I use this:
<pre>
   splash.rle

   *** MODIFIED ***       see http://hands.com/d-i/ for details

   Press F1-control ...
</pre>
<b>Note:</b> that that file contains control characters, and ends without a
newline, so you'll need to edit it with something that will leave that
intact (I use emacs).

Now make the new iso image:
<pre>
$ mkisofs -o d-i-CD/new.iso -r -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table d-i-CD/new
</pre>  
and burn it with something like this:
<pre>
$ cdrecord -v speed=16 dev=/dev/cdroms/cdrom0 -eject driveropts=burnproof d-i-CD/new.iso
</pre>

<p>Once you've got a CD, boot from it, and read http://hands.com/d-i/ for
hints on what to type at the boot prompt to kick things off.

<p>Have Fun!

<pre>
TODO:

  Make a CD with all the preseed files, all the associated scripts,
  and all the packages that get downloaded, so that you can preseed a
  machine with no NIC -- if anyone does this, please tell me about it.

</pre>
</small>
<address><a href="mailto:&#112;&#104;&#105;&#108;&#064;&#104;&#097;&#110;&#100;&#115;&#046;&#099;&#111;&#109;">Philip Hands</a></address>
  </body>
</html>
