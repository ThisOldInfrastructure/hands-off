#!/bin/bash

log() {
    logger -t install_script "$@"
}

debconf-get() {
    echo GET $1 | debconf-communicate | cut -d ' ' -f 2
}

echo 'debian-installer post-install "install_script" from http://hands.com/d-i/'
log 'debug: running debian-installer post-install "install_script" from http://hands.com/d-i/'

# I'm lazy -- this lets me retry an install, by typing up-arrow return
echo "dd if=/dev/zero of=/dev/hda count=1 ; sync ; reboot -f" > /root/.bash_history
chmod 600 /root/.bash_history

# FIXME -- should never get loaded in the first place
# don't need these
apt-get -y remove mdetect read-edid

# install ssh, and stop root login by password --- no race condition if root has no password :-)
apt-get -y install ssh
sed -i -e 's/^PermitRootLogin *yes/PermitRootLogin without-password/' /etc/ssh/sshd_config
/etc/init.d/ssh restart
# can set a root password here reasonably safely

# FIXME -- make this check local/site
#since this is the default location, let's just set it empty
sed -i -e 's#^root:[^:]*:#root::#' /etc/shadow

# make sure we have md5sums for all packages we install
apt-get -y install debsums
cat >> /etc/apt/apt.conf <<!EOF!
DPkg::Post-Invoke {
        "debsums --generate=nocheck -sp /var/cache/apt/archives";
};
!EOF!

# nice stuff, even on a minmal box
apt-get -y install debconf-utils less udev sudo rsync debsums

# set LESSPIPE as I prefer
sed -i -e '/^  if \[ "$BASH" ]; then$/a\    . /etc/bash.bashrc' /etc/profile
echo "export LESSOPEN=\"|lesspipe '%s'\"" >> /etc/bash.bashrc

wget http://hands.com/d-i/site-files/$(debconf-get local/site)/type-files/$(debconf-get local/type)/install_script -O /var/tmp/site-type-install_script
exec sh /var/tmp/site-type-install_script

log 'debug: exiting successfully'
exit 0
